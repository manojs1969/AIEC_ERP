Option Compare Database
Option Explicit

Public Sub ExportCurrentStockToExcel(Optional ByVal pStoreID As Long = 0)
    On Error GoTo ErrHandler

    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim sql As String
    Dim xlApp As Object
    Dim xlWb As Object
    Dim xlWs As Object
    Dim row As Long
    Dim storeName As String
    Dim curStoreName As String
    Dim storeSubtotalStock As Double
    Dim storeSubtotalAmount As Currency
    Dim grandTotalStock As Double
    Dim grandTotalAmount As Currency
    Dim amountVal As Currency
    Dim companyName As String
    Dim titleText As String
    Dim asAtText As String
    Dim saveFile As Variant
    Dim fldStoreFilter As String
    Dim storeColorFlag As Boolean

    Set db = CurrentDb

    companyName = "Aman Infra Engineering and Construction"
    titleText = "Current Stock - Store Wise"
    asAtText = "As at: " & Format(Now, "dd\/mm\/yyyy HH:nn:ss") & _
               "    Generated by: " & Replace(Environ$("USERNAME"), "'", "''")

    If pStoreID > 0 Then
        fldStoreFilter = " AND [ss].[StoreID] = " & CLng(pStoreID)
    Else
        fldStoreFilter = ""
    End If

    ' Query
    sql = _
      "SELECT Nz([l].[SiteName],'Unknown') AS StoreName, [ss].[StoreID], [ss].[ItemID], " & _
      "Nz([i].[ItemCode],'') AS ItemCode, Nz([i].[ItemName],'') AS ItemName, Nz([i].[UOM],'') AS UOM, " & _
      "Nz([ss].[CurrentStock],0) AS CurrentStock, Nz([ss].[LastRate],0) AS LastRate " & _
      "FROM ([tblStoreStock] AS ss LEFT JOIN [tblItem] AS i ON [ss].[ItemID]=[i].[ItemID]) " & _
      "LEFT JOIN [Location] AS l ON [ss].[StoreID]=[l].[LocationID] " & _
      "WHERE Nz([ss].[CurrentStock],0)<>0 " & fldStoreFilter & _
      " ORDER BY Nz([l].[SiteName],'Unknown'), Nz([i].[ItemName],'');"

    Debug.Print "ExportCurrentStockToExcel SQL:" & vbCrLf & sql

    Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
    If rs.EOF Then
        MsgBox "No stock data found for the specified filter.", vbInformation, "No Data"
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    ' Excel setup
    Set xlApp = CreateObject("Excel.Application")
    On Error Resume Next
    saveFile = xlApp.GetSaveAsFilename(InitialFileName:="CurrentStock_StoreWise_" & _
                Format(Now, "yyyymmdd_HHNNSS") & ".xlsx", _
                FileFilter:="Excel Files (*.xlsx), *.xlsx")
    On Error GoTo ErrHandler

    If VarType(saveFile) = vbBoolean Then
        xlApp.Quit
        Set xlApp = Nothing
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    Set xlWb = xlApp.Workbooks.Add
    Set xlWs = xlWb.Worksheets(1)
    xlWs.Name = "CurrentStock"

    ' Report Header
    row = 1
    xlWs.Cells(row, 1).value = companyName
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 14
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).value = titleText
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 12
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).value = asAtText
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 2

    ' Column Headers
    Dim hdrRow As Long
    hdrRow = row
    xlWs.Cells(hdrRow, 1).value = "Store"
    xlWs.Cells(hdrRow, 2).value = "ItemID"
    xlWs.Cells(hdrRow, 3).value = "ItemCode"
    xlWs.Cells(hdrRow, 4).value = "ItemName"
    xlWs.Cells(hdrRow, 5).value = "UOM"
    xlWs.Cells(hdrRow, 6).value = "CurrentStock"
    xlWs.Cells(hdrRow, 7).value = "Rate"
    xlWs.Cells(hdrRow, 8).value = "Amount"
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(hdrRow, 8)).Font.Bold = True
    row = hdrRow + 1

    ' Data Loop
    curStoreName = ""
    storeSubtotalStock = 0
    storeSubtotalAmount = 0
    grandTotalStock = 0
    grandTotalAmount = 0
    storeColorFlag = False

    Do While Not rs.EOF
        storeName = Nz(rs!storeName, "Unknown")

        ' If store changed
        If curStoreName <> "" And storeName <> curStoreName Then
            ' Subtotal
            xlWs.Cells(row, 1).value = curStoreName & " - Subtotal"
            xlWs.Cells(row, 6).value = storeSubtotalStock
            xlWs.Cells(row, 8).value = storeSubtotalAmount
            xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
            xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
            xlWs.Cells(row, 8).NumberFormat = "#,##0.00"
            row = row + 2

            ' Toggle store color
            storeColorFlag = Not storeColorFlag

            ' New Store Header
            xlWs.Cells(row, 1).value = storeName
            xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
            If storeColorFlag Then
                xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Interior.Color = RGB(220, 230, 241) ' light blue
            Else
                xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Interior.Color = RGB(242, 242, 242) ' light gray
            End If
            row = row + 1

            storeSubtotalStock = 0
            storeSubtotalAmount = 0
        End If

        ' First store header
        If curStoreName = "" Then
            xlWs.Cells(row, 1).value = storeName
            xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
            If storeColorFlag Then
                xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Interior.Color = RGB(220, 230, 241)
            Else
                xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Interior.Color = RGB(242, 242, 242)
            End If
            row = row + 1
        End If

        curStoreName = storeName
        amountVal = Nz(rs!CurrentStock, 0) * Nz(rs!lastRate, 0)

        ' Item row
        xlWs.Cells(row, 1).value = ""
        xlWs.Cells(row, 2).value = Nz(rs!ItemID, 0)
        xlWs.Cells(row, 3).value = Nz(rs!ItemCode, "")
        xlWs.Cells(row, 4).value = Nz(rs!ItemName, "")
        xlWs.Cells(row, 5).value = Nz(rs!UOM, "")
        xlWs.Cells(row, 6).value = Nz(rs!CurrentStock, 0)
        xlWs.Cells(row, 7).value = Nz(rs!lastRate, 0)
        xlWs.Cells(row, 8).value = amountVal

        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 7).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

        storeSubtotalStock = storeSubtotalStock + Nz(rs!CurrentStock, 0)
        storeSubtotalAmount = storeSubtotalAmount + amountVal
        grandTotalStock = grandTotalStock + Nz(rs!CurrentStock, 0)
        grandTotalAmount = grandTotalAmount + amountVal

        row = row + 1
        rs.MoveNext
    Loop

    ' Final Store Subtotal
    If curStoreName <> "" Then
        xlWs.Cells(row, 1).value = curStoreName & " - Subtotal"
        xlWs.Cells(row, 6).value = storeSubtotalStock
        xlWs.Cells(row, 8).value = storeSubtotalAmount
        xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"
        row = row + 2
    End If

    ' Grand Total
    xlWs.Cells(row, 1).value = "Grand Total"
    xlWs.Cells(row, 6).value = grandTotalStock
    xlWs.Cells(row, 8).value = grandTotalAmount
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
    xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
    xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

    ' Formatting
    xlWs.Columns("A:H").AutoFit
    xlWs.Application.ActiveWindow.SplitRow = hdrRow
    xlWs.Application.ActiveWindow.FreezePanes = True
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(row, 8)).AutoFilter

    xlWb.SaveAs saveFile
    xlApp.Visible = True

    rs.Close
    Set rs = Nothing
    Set db = Nothing
    Set xlWs = Nothing
    Set xlWb = Nothing
    Set xlApp = Nothing

    MsgBox "Export completed successfully!" & vbCrLf & saveFile, vbInformation, "Export Success"
    Exit Sub

ErrHandler:
    Dim errMsg As String
    errMsg = "Error exporting Current Stock: (" & Err.Number & ") " & Err.Description
    Debug.Print errMsg
    Debug.Print "SQL:" & vbCrLf & sql
    If Not rs Is Nothing Then On Error Resume Next: rs.Close: Set rs = Nothing
    If Not xlApp Is Nothing Then On Error Resume Next: xlApp.Quit: Set xlApp = Nothing
    Set db = Nothing
    MsgBox errMsg, vbCritical, "Export Error"
End Sub


Private Sub btnExportRpt_Click()
    Dim chosenStore As Long
    If Me.optAllStores = True Then
        chosenStore = 0
    Else
        chosenStore = Nz(Me.cboStoreID, 0)
    End If
    Debug.Print "Export requested. chosenStore=" & chosenStore
    ExportCurrentStockToExcel chosenStore
End Sub

------------------------------------------
Opt-2
Option Compare Database
Option Explicit

Public Sub ExportCurrentStockToExcel(Optional ByVal pStoreID As Long = 0)
    On Error GoTo ErrHandler

    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim sql As String
    Dim xlApp As Object ' Excel.Application
    Dim xlWb As Object  ' Excel.Workbook
    Dim xlWs As Object  ' Excel.Worksheet
    Dim row As Long
    Dim companyName As String
    Dim titleText As String
    Dim asAtText As String
    Dim saveFile As Variant
    Dim fldStoreFilter As String
    Dim grandTotalStock As Double
    Dim grandTotalAmount As Currency
    Dim amountVal As Currency

    Set db = CurrentDb

    companyName = "Aman Infra Engineering and Construction"
    titleText = "Current Stock - Store Wise"
    asAtText = "As at: " & Format(Now, "dd\/mm\/yyyy HH:nn:ss") & _
               "    Generated by: " & Replace(Environ$("USERNAME"), "'", "''")

    fldStoreFilter = ""
    If pStoreID > 0 Then
        fldStoreFilter = " AND [ss].[StoreID] = " & CLng(pStoreID)
    End If

    sql = _
      "SELECT Nz([l].[SiteName], 'Unknown') AS StoreName, [ss].[StoreID], [ss].[ItemID], " & _
      "Nz([i].[ItemCode], '') AS ItemCode, Nz([i].[ItemName], '') AS ItemName, Nz([i].[UOM], '') AS UOM, " & _
      "Nz([ss].[CurrentStock],0) AS CurrentStock, Nz([ss].[LastRate],0) AS LastRate " & _
      "FROM ([tblStoreStock] AS ss LEFT JOIN [tblItem] AS i ON [ss].[ItemID] = [i].[ItemID]) " & _
      "LEFT JOIN [Location] AS l ON [ss].[StoreID] = [l].[LocationID] " & _
      "WHERE Nz([ss].[CurrentStock],0) <> 0 " & fldStoreFilter & " " & _
      "ORDER BY Nz([l].[SiteName],'Unknown'), Nz([i].[ItemName],'');"

    Debug.Print "ExportCurrentStockToExcel SQL: " & vbCrLf & sql

    Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
    If rs.EOF Then
        MsgBox "No stock data found for the specified filter.", vbInformation, "No Data"
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    ' Prompt Save As filename
    Set xlApp = CreateObject("Excel.Application")
    On Error Resume Next
    saveFile = xlApp.GetSaveAsFilename(InitialFileName:="CurrentStock_StoreWise_" & _
                Format(Now, "yyyymmdd_HHNNSS") & ".xlsx", _
                FileFilter:="Excel Files (*.xlsx), *.xlsx")
    On Error GoTo ErrHandler

    If VarType(saveFile) = vbBoolean Then ' user cancelled
        xlApp.Quit
        Set xlApp = Nothing
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    Set xlWb = xlApp.Workbooks.Add
    Set xlWs = xlWb.Worksheets(1)
    xlWs.Name = "CurrentStock"

    '====================================================
    ' HEADER SECTION
    '====================================================
    row = 1
    xlWs.Cells(row, 1).Value = companyName
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 14
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = titleText
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 12
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = asAtText
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 2

    '====================================================
    ' COLUMN HEADERS
    '====================================================
    xlWs.Cells(row, 1).Value = "Store"
    xlWs.Cells(row, 2).Value = "ItemID"
    xlWs.Cells(row, 3).Value = "ItemCode"
    xlWs.Cells(row, 4).Value = "ItemName"
    xlWs.Cells(row, 5).Value = "UOM"
    xlWs.Cells(row, 6).Value = "CurrentStock"
    xlWs.Cells(row, 7).Value = "Rate"
    xlWs.Cells(row, 8).Value = "Amount"
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True

    Dim hdrRow As Long
    hdrRow = row
    row = row + 1

    '====================================================
    ' DATA LOOP
    '====================================================
    grandTotalStock = 0
    grandTotalAmount = 0

    Do While Not rs.EOF
        amountVal = Nz(rs!CurrentStock, 0) * Nz(rs!LastRate, 0)

        xlWs.Cells(row, 1).Value = Nz(rs!StoreName, "Unknown")
        xlWs.Cells(row, 2).Value = Nz(rs!ItemID, 0)
        xlWs.Cells(row, 3).Value = Nz(rs!ItemCode, "")
        xlWs.Cells(row, 4).Value = Nz(rs!ItemName, "")
        xlWs.Cells(row, 5).Value = Nz(rs!UOM, "")
        xlWs.Cells(row, 6).Value = Nz(rs!CurrentStock, 0)
        xlWs.Cells(row, 7).Value = Nz(rs!LastRate, 0)
        xlWs.Cells(row, 8).Value = amountVal

        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 7).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

        grandTotalStock = grandTotalStock + Nz(rs!CurrentStock, 0)
        grandTotalAmount = grandTotalAmount + amountVal

        row = row + 1
        rs.MoveNext
    Loop

    '====================================================
    ' GRAND TOTAL
    '====================================================
    xlWs.Cells(row, 1).Value = "Grand Total"
    xlWs.Cells(row, 6).Value = grandTotalStock
    xlWs.Cells(row, 8).Value = grandTotalAmount
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
    xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
    xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

    Dim lastDataRow As Long
    lastDataRow = row

    '====================================================
    ' FORMATTING & SAVE
    '====================================================
    xlWs.Columns("A:H").AutoFit
    xlWs.Application.ActiveWindow.SplitRow = hdrRow
    xlWs.Application.ActiveWindow.FreezePanes = True
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(lastDataRow, 8)).AutoFilter

    xlWb.SaveAs saveFile
    xlApp.Visible = True

    rs.Close
    Set rs = Nothing
    Set db = Nothing
    Set xlWs = Nothing
    Set xlWb = Nothing
    Set xlApp = Nothing

    MsgBox "Export completed: " & saveFile, vbInformation, "Export Success"
    Exit Sub

ErrHandler:
    Dim errMsg As String
    errMsg = "Error exporting Current Stock: (" & Err.Number & ") " & Err.Description
    Debug.Print errMsg
    Debug.Print "SQL was:" & vbCrLf & sql
    If Not rs Is Nothing Then On Error Resume Next: rs.Close: Set rs = Nothing
    If Not xlApp Is Nothing Then On Error Resume Next: xlApp.Quit: Set xlApp = Nothing
    Set db = Nothing
    MsgBox errMsg, vbCritical, "Export Error"
End Sub
-------------------------------------------------------------------------------------
Opt-3
Option Compare Database
Option Explicit

' Two variants to address UOM/subtotal concerns:
' 1) ExportCurrentStockToExcel_NoSubtotals - exports rows grouped by Store but does NOT write numeric subtotals (recommended when UOMs differ)
' 2) ExportCurrentStockToExcel_UOMSubtotals - exports rows and writes subtotals for each UOM within each store (only meaningful if you want per-UOM totals)
'
' Call either from your form's btnExportRpt_Click:
'   If Me.optAllStores = True Then ExportCurrentStockToExcel_NoSubtotals 0 Else ExportCurrentStockToExcel_NoSubtotals Nz(Me.cboStoreID,0)
' or use the UOM-subtotal variant similarly.
'
' These routines follow the same SQL and Excel formatting approach used previously (late-bound Excel).
' They require the same DB schema: [tblStoreStock], [tblItem], [Location] as used earlier.

' -------------------------
' Variant 1: No subtotals
' -------------------------
Public Sub ExportCurrentStockToExcel_NoSubtotals(Optional ByVal pStoreID As Long = 0)
    On Error GoTo ErrHandler

    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim sql As String
    Dim xlApp As Object, xlWb As Object, xlWs As Object
    Dim row As Long, hdrRow As Long
    Dim companyName As String, titleText As String, asAtText As String
    Dim saveFile As Variant
    Dim fldStoreFilter As String

    Set db = CurrentDb

    companyName = "AIEC ERP"
    titleText = "Current Stock - Store Wise"
    asAtText = "As at: " & Format(Now, "yyyy\/mm\/dd HH:nn:ss") & "    Generated by: " & Replace(Environ$("USERNAME"), "'", "''")

    fldStoreFilter = ""
    If pStoreID > 0 Then fldStoreFilter = " AND [ss].[StoreID] = " & CLng(pStoreID)

    sql = _
      "SELECT Nz([l].[SiteName], 'Unknown') AS StoreName, [ss].[StoreID], [ss].[ItemID], " & _
      "Nz([i].[ItemCode], '') AS ItemCode, Nz([i].[ItemName], '') AS ItemName, Nz([i].[UOM], '') AS UOM, " & _
      "Nz([ss].[CurrentStock],0) AS CurrentStock, Nz([ss].[LastRate],0) AS LastRate " & _
      "FROM ([tblStoreStock] AS ss LEFT JOIN [tblItem] AS i ON [ss].[ItemID] = [i].[ItemID]) " & _
      "LEFT JOIN [Location] AS l ON [ss].[StoreID] = [l].[LocationID] " & _
      "WHERE Nz([ss].[CurrentStock],0) <> 0 " & fldStoreFilter & " " & _
      "ORDER BY Nz([l].[SiteName],'Unknown'), Nz([i].[ItemName],'');"

    Debug.Print "ExportCurrentStockToExcel_NoSubtotals SQL:" & vbCrLf & sql

    Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
    If rs.EOF Then
        MsgBox "No stock data found for the specified filter.", vbInformation, "No Data"
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    Set xlApp = CreateObject("Excel.Application")
    On Error Resume Next
    saveFile = xlApp.GetSaveAsFilename(InitialFileName:="CurrentStock_StoreWise_" & Format(Now, "yyyymmdd_HHNNSS") & ".xlsx", _
                                      FileFilter:="Excel Files (*.xlsx), *.xlsx")
    On Error GoTo ErrHandler
    If VarType(saveFile) = vbBoolean Then xlApp.Quit: Set xlApp = Nothing: rs.Close: Set rs = Nothing: Set db = Nothing: Exit Sub

    Set xlWb = xlApp.Workbooks.Add
    Set xlWs = xlWb.Worksheets(1)
    xlWs.Name = "CurrentStock"

    row = 1
    xlWs.Cells(row, 1).Value = companyName
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 14
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = titleText
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 12
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = asAtText
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 2

    hdrRow = row
    xlWs.Cells(hdrRow, 1).Value = "Store"
    xlWs.Cells(hdrRow, 2).Value = "ItemID"
    xlWs.Cells(hdrRow, 3).Value = "ItemCode"
    xlWs.Cells(hdrRow, 4).Value = "ItemName"
    xlWs.Cells(hdrRow, 5).Value = "UOM"
    xlWs.Cells(hdrRow, 6).Value = "CurrentStock"
    xlWs.Cells(hdrRow, 7).Value = "Rate"
    xlWs.Cells(hdrRow, 8).Value = "Amount"
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(hdrRow, 8)).Font.Bold = True
    row = hdrRow + 1

    Do While Not rs.EOF
        xlWs.Cells(row, 1).Value = Nz(rs!StoreName, "Unknown")
        xlWs.Cells(row, 2).Value = Nz(rs!ItemID, 0)
        xlWs.Cells(row, 3).Value = Nz(rs!ItemCode, "")
        xlWs.Cells(row, 4).Value = Nz(rs!ItemName, "")
        xlWs.Cells(row, 5).Value = Nz(rs!UOM, "")
        xlWs.Cells(row, 6).Value = Nz(rs!CurrentStock, 0)
        xlWs.Cells(row, 7).Value = Nz(rs!LastRate, 0)
        xlWs.Cells(row, 8).Value = Nz(rs!CurrentStock, 0) * Nz(rs!LastRate, 0)

        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 7).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

        row = row + 1
        rs.MoveNext
    Loop

    xlWs.Columns("A:H").AutoFit
    xlWs.Application.ActiveWindow.SplitRow = hdrRow
    xlWs.Application.ActiveWindow.FreezePanes = True
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(row - 1, 8)).AutoFilter

    xlWb.SaveAs saveFile
    xlApp.Visible = True

    rs.Close: Set rs = Nothing
    Set db = Nothing: Set xlWs = Nothing: Set xlWb = Nothing: Set xlApp = Nothing

    MsgBox "Export completed: " & saveFile, vbInformation, "Export Success"
    Exit Sub

ErrHandler:
    Dim errMsg As String
    errMsg = "Error exporting Current Stock (NoSubtotals): (" & Err.Number & ") " & Err.Description
    Debug.Print errMsg
    Debug.Print "SQL: " & sql
    If Not rs Is Nothing Then On Error Resume Next: rs.Close: Set rs = Nothing
    If Not xlApp Is Nothing Then On Error Resume Next: xlApp.Quit: Set xlApp = Nothing
    Set db = Nothing
    MsgBox errMsg, vbCritical, "Export Error"
End Sub

' -------------------------
' Variant 2: Subtotals by UOM within each Store
' -------------------------
Public Sub ExportCurrentStockToExcel_UOMSubtotals(Optional ByVal pStoreID As Long = 0)
    On Error GoTo ErrHandler

    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim sql As String
    Dim xlApp As Object, xlWb As Object, xlWs As Object
    Dim row As Long, hdrRow As Long
    Dim companyName As String, titleText As String, asAtText As String
    Dim saveFile As Variant
    Dim fldStoreFilter As String

    Dim curStore As String, curUOM As String
    Dim subtotalStockUOM As Double, subtotalAmountUOM As Currency

    Set db = CurrentDb

    companyName = "AIEC ERP"
    titleText = "Current Stock - Store Wise (UOM subtotals)"
    asAtText = "As at: " & Format(Now, "yyyy\/mm\/dd HH:nn:ss") & "    Generated by: " & Replace(Environ$("USERNAME"), "'", "''")

    fldStoreFilter = ""
    If pStoreID > 0 Then fldStoreFilter = " AND [ss].[StoreID] = " & CLng(pStoreID)

    ' ORDER BY Store, UOM, ItemName so we can subtotal per UOM
    sql = _
      "SELECT Nz([l].[SiteName], 'Unknown') AS StoreName, [ss].[StoreID], [ss].[ItemID], " & _
      "Nz([i].[ItemCode], '') AS ItemCode, Nz([i].[ItemName], '') AS ItemName, Nz([i].[UOM], '') AS UOM, " & _
      "Nz([ss].[CurrentStock],0) AS CurrentStock, Nz([ss].[LastRate],0) AS LastRate " & _
      "FROM ([tblStoreStock] AS ss LEFT JOIN [tblItem] AS i ON [ss].[ItemID] = [i].[ItemID]) " & _
      "LEFT JOIN [Location] AS l ON [ss].[StoreID] = [l].[LocationID] " & _
      "WHERE Nz([ss].[CurrentStock],0) <> 0 " & fldStoreFilter & " " & _
      "ORDER BY Nz([l].[SiteName],'Unknown'), Nz([i].[UOM],''), Nz([i].[ItemName],'');"

    Debug.Print "ExportCurrentStockToExcel_UOMSubtotals SQL:" & vbCrLf & sql

    Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
    If rs.EOF Then
        MsgBox "No stock data found for the specified filter.", vbInformation, "No Data"
        rs.Close: Set rs = Nothing: Set db = Nothing
        Exit Sub
    End If

    Set xlApp = CreateObject("Excel.Application")
    On Error Resume Next
    saveFile = xlApp.GetSaveAsFilename(InitialFileName:="CurrentStock_StoreWise_UOM_" & Format(Now, "yyyymmdd_HHNNSS") & ".xlsx", _
                                      FileFilter:="Excel Files (*.xlsx), *.xlsx")
    On Error GoTo ErrHandler
    If VarType(saveFile) = vbBoolean Then xlApp.Quit: Set xlApp = Nothing: rs.Close: Set rs = Nothing: Set db = Nothing: Exit Sub

    Set xlWb = xlApp.Workbooks.Add
    Set xlWs = xlWb.Worksheets(1)
    xlWs.Name = "CurrentStock"

    row = 1
    xlWs.Cells(row, 1).Value = companyName
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 14
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = titleText
    xlWs.Cells(row, 1).Font.Bold = True
    xlWs.Cells(row, 1).Font.Size = 12
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 1

    xlWs.Cells(row, 1).Value = asAtText
    xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Merge
    row = row + 2

    hdrRow = row
    xlWs.Cells(hdrRow, 1).Value = "Store"
    xlWs.Cells(hdrRow, 2).Value = "ItemID"
    xlWs.Cells(hdrRow, 3).Value = "ItemCode"
    xlWs.Cells(hdrRow, 4).Value = "ItemName"
    xlWs.Cells(hdrRow, 5).Value = "UOM"
    xlWs.Cells(hdrRow, 6).Value = "CurrentStock"
    xlWs.Cells(hdrRow, 7).Value = "Rate"
    xlWs.Cells(hdrRow, 8).Value = "Amount"
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(hdrRow, 8)).Font.Bold = True
    row = hdrRow + 1

    curStore = ""
    curUOM = ""
    subtotalStockUOM = 0
    subtotalAmountUOM = 0

    Do While Not rs.EOF
        Dim storeName As String, uom As String
        storeName = Nz(rs!StoreName, "Unknown")
        uom = Nz(rs!UOM, "")

        ' If store changed, flush any pending UOM subtotal and continue
        If curStore <> "" And storeName <> curStore Then
            ' flush last UOM subtotal of previous store
            If curUOM <> "" Then
                xlWs.Cells(row, 1).Value = curStore & " - UOM Subtotal (" & curUOM & ")"
                xlWs.Cells(row, 6).Value = subtotalStockUOM
                xlWs.Cells(row, 8).Value = subtotalAmountUOM
                xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
                xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
                xlWs.Cells(row, 8).NumberFormat = "#,##0.00"
                row = row + 1
            End If
            ' reset UOM tracking for new store
            curUOM = ""
            subtotalStockUOM = 0
            subtotalAmountUOM = 0
        End If

        ' If UOM changed within same store, write previous UOM subtotal
        If curUOM <> "" And uom <> curUOM Then
            xlWs.Cells(row, 1).Value = curStore & " - UOM Subtotal (" & curUOM & ")"
            xlWs.Cells(row, 6).Value = subtotalStockUOM
            xlWs.Cells(row, 8).Value = subtotalAmountUOM
            xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
            xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
            xlWs.Cells(row, 8).NumberFormat = "#,##0.00"
            row = row + 1
            subtotalStockUOM = 0
            subtotalAmountUOM = 0
        End If

        curStore = storeName
        curUOM = uom

        xlWs.Cells(row, 1).Value = storeName
        xlWs.Cells(row, 2).Value = Nz(rs!ItemID, 0)
        xlWs.Cells(row, 3).Value = Nz(rs!ItemCode, "")
        xlWs.Cells(row, 4).Value = Nz(rs!ItemName, "")
        xlWs.Cells(row, 5).Value = uom
        xlWs.Cells(row, 6).Value = Nz(rs!CurrentStock, 0)
        xlWs.Cells(row, 7).Value = Nz(rs!LastRate, 0)
        xlWs.Cells(row, 8).Value = Nz(rs!CurrentStock, 0) * Nz(rs!LastRate, 0)

        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 7).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"

        subtotalStockUOM = subtotalStockUOM + Nz(rs!CurrentStock, 0)
        subtotalAmountUOM = subtotalAmountUOM + Nz(rs!CurrentStock, 0) * Nz(rs!LastRate, 0)

        row = row + 1
        rs.MoveNext
    Loop

    ' flush last UOM subtotal if present
    If curUOM <> "" Then
        xlWs.Cells(row, 1).Value = curStore & " - UOM Subtotal (" & curUOM & ")"
        xlWs.Cells(row, 6).Value = subtotalStockUOM
        xlWs.Cells(row, 8).Value = subtotalAmountUOM
        xlWs.Range(xlWs.Cells(row, 1), xlWs.Cells(row, 8)).Font.Bold = True
        xlWs.Cells(row, 6).NumberFormat = "#,##0.00"
        xlWs.Cells(row, 8).NumberFormat = "#,##0.00"
        row = row + 1
    End If

    xlWs.Columns("A:H").AutoFit
    xlWs.Application.ActiveWindow.SplitRow = hdrRow
    xlWs.Application.ActiveWindow.FreezePanes = True
    xlWs.Range(xlWs.Cells(hdrRow, 1), xlWs.Cells(row - 1, 8)).AutoFilter

    xlWb.SaveAs saveFile
    xlApp.Visible = True

    rs.Close: Set rs = Nothing
    Set db = Nothing: Set xlWs = Nothing: Set xlWb = Nothing: Set xlApp = Nothing

    MsgBox "Export completed: " & saveFile, vbInformation, "Export Success"
    Exit Sub

ErrHandler:
    Dim errMsg As String
    errMsg = "Error exporting Current Stock (UOMSubtotals): (" & Err.Number & ") " & Err.Description
    Debug.Print errMsg
    Debug.Print "SQL: " & sql
    If Not rs Is Nothing Then On Error Resume Next: rs.Close: Set rs = Nothing
    If Not xlApp Is Nothing Then On Error Resume Next: xlApp.Quit: Set xlApp = Nothing
    Set db = Nothing
    MsgBox errMsg, vbCritical, "Export Error"
End Sub